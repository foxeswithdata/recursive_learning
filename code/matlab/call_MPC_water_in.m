S0 = 550;
W0 = 50;
M0 = 3300;

% ri = [0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 44.97116  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 0.00000  0.00000  0.00000  0.00000 65.75602  0.00000  0.00000 27.86544  0.00000  0.00000  0.00000 28.99561  0.00000  0.00000 0.00000  0.00000 29.85251 25.29736 39.11327 55.15084 40.33066  0.00000  0.00000 37.79152  0.00000 55.90280  0.00000  0.00000 32.27872 40.95135 38.51757 37.32426 52.60985 31.00911 48.35350  0.00000 36.13249  0.00000  0.00000  0.00000 32.71036  0.00000 0.00000  0.00000  0.00000  0.00000 43.33404  0.00000  0.00000  0.00000  0.00000 38.62308 50.17503 56.84198  0.00000 38.54251 36.73649 52.57229 33.30462  0.00000  0.00000  0.00000  0.00000 33.84840 57.14595 39.20793 70.83283  0.00000  0.00000  0.00000 0.00000  0.00000 47.96435 34.25741 40.72880 58.54616 37.38026  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 34.19464 35.14720 47.67437  0.00000 35.00915 36.15794  0.00000 39.88059  0.00000  0.00000 46.56413 37.24047  0.00000  0.00000  0.00000 27.38285 48.41236  0.00000  0.00000  0.00000 33.05096 32.29945 39.29938  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 41.03552 39.26319 36.65218 50.21381 34.87198  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 35.47622 52.58698  0.00000 25.07190  0.00000  0.00000 37.63503  0.00000 45.68605  0.00000  0.00000  0.00000  0.00000  0.00000];
ri = [32.30574 28.81493 45.23804 39.08594 46.92608  0.00000 42.05357 42.14653 36.82639  0.00000  0.00000 27.10817 65.65147 ...
    40.85251  0.00000  0.00000 24.66867  0.00000  0.00000 45.14815 34.79740 49.66188 52.53922 51.54855 32.64569 39.90972 ...
    59.47834  0.00000  0.00000 30.86151 29.10017 22.96994 33.98346 22.83858 36.97548 34.49276 33.47493 32.80177 32.99884 ...
32.86356 45.69457 46.62872 36.25070 35.89218  0.00000  0.00000  0.00000  0.00000 27.39798 36.71877 36.55987 51.92162 ...
26.83294 30.01222 39.05832 41.27991 53.79303 50.55972 53.42327 38.14068 33.50290 38.00386 34.69497 54.84132 30.64656 ...
36.64141  0.00000  0.00000  0.00000  0.00000 48.66819 48.81835 45.39661 27.69628 39.40741  0.00000 46.32176 29.22254 ...
37.01667 30.23178 45.31359 52.05260 69.65689 42.94322 28.70019 29.77819 38.52614 43.58502 34.01188 33.94846 41.00888 ...
42.19512 36.46396 24.13492 44.03667 49.17387 43.95661  0.00000  0.00000  0.00000 40.06573 44.78000  0.00000 29.73654 ...
29.32549 31.63068  0.00000  0.00000  0.00000  0.00000 57.40941 44.98816 34.85365 42.54719 56.12523  0.00000 55.70204 ...
0.00000  0.00000 34.42173  0.00000  0.00000  0.00000  0.00000 32.36875 37.09257 33.39490 47.68008 41.08785 35.09643...
33.77138 47.96575 36.79406 30.05836  0.00000 31.48923 46.31720  0.00000  0.00000  0.00000 31.61950 38.24446  0.00000 ...
29.99861 42.50942 46.38960 43.43127  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 ...
0.00000 21.71490 55.42673 52.83994 38.77941 37.25538 45.31470  0.00000  0.00000  0.00000 30.45378  0.00000  0.00000 ...
0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 ...
0.00000  0.00000  0.00000 41.42161  0.00000  0.00000  0.00000 31.22097 41.25340  0.00000  0.00000  0.00000 22.94547 ...
40.86466  0.00000 30.76295  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 ...
0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 54.65267  0.00000  0.00000  0.00000 40.60340  0.00000  0.00000 ...
0.00000 34.37993 74.82007 48.17269 45.74523 38.85931  0.00000  0.00000 40.89970 36.47278 29.35037  0.00000  0.00000 ...
0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 30.79778 28.41774 ...
39.47823 40.33961 33.27233 25.04294];

% ri = [0.00000  0.00000 25.55950 57.47675  0.00000 46.25609  0.00000 32.27200  0.00000 49.87524 49.98220  0.00000  0.00000 ...
%  36.07524 61.70717 33.70154 37.99596 37.33065 53.92959 44.51750 30.26242 33.48681 37.05267 38.43601 61.75504 38.65405 ...
%  36.94010  0.00000  0.00000 39.16799 34.91803 28.59440  0.00000 37.70095 35.30828 35.64343 28.81287 47.65045  0.00000 ...
%  0.00000 32.51694  0.00000  0.00000  0.00000  0.00000 39.90354 47.41832 37.51384 39.16910 34.56179  0.00000  0.00000 ...
%  39.36074 48.89345  0.00000  0.00000 24.49466 39.73878  0.00000  0.00000 33.83615 36.56081 42.77249 19.93185 34.59547 ...
%  36.73927 54.72012  0.00000 32.42135 31.93208  0.00000  0.00000  0.00000  0.00000 32.24427 26.95272  0.00000  0.00000 ...
%  57.98888  0.00000 37.12522 31.03778  0.00000 48.69088 38.74579 51.89173 41.43344 39.49838 46.99551 45.50646  0.00000 ...
%  43.41006 36.97912 53.91576 37.35095 40.20512 39.47239 34.67333 47.32876 39.40118 42.96268 52.14326  0.00000 42.05618 ...
% 36.76316 20.70220  0.00000 42.38530 33.90479 29.71612 25.59017 37.85222 28.96588 42.43484 43.62919 35.40406 51.44228 ...
% 0.00000  0.00000 31.91686 35.65726  0.00000  0.00000  0.00000 42.05488 44.35047 26.04542 22.84738  0.00000 55.99942 ...
% 25.20646 38.92432  0.00000 36.81776 41.53514 73.30385 35.79876 31.06853 32.98427 40.74836 55.96502 42.42445 62.55240 ...
% 42.85938 25.57835  0.00000  0.00000  0.00000  0.00000  0.00000 27.68855 33.98338 62.60428 39.55187 47.04105 42.45889 ...
% 53.74048 36.49948 46.03902 29.90919  0.00000  0.00000  0.00000  0.00000  0.00000 61.25519  0.00000  0.00000 32.28802 ...
% 38.05827  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 44.37720 40.37106 44.62431  0.00000  0.00000  0.00000 ...
% 0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 41.42271 48.00448 ...
% 27.90141 50.14989 42.87211  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 25.01850 50.59508 39.01204 ...
% 36.64105 44.18367  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 33.48697  0.00000  0.00000  0.00000 ...
% 37.46681 29.99010  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 ...
% 0.00000  0.00000 43.85802  0.00000 25.85899 33.01836 44.45742 46.91144 38.00385 36.55905 42.26820  0.00000 39.59353 ...
% 0.00000  0.00000  0.00000  0.00000];

% ri = [39.58226 32.23124 37.76783  0.00000  0.00000 44.85672  0.00000 39.65218 45.72424 33.18829  0.00000  0.00000  0.00000...
%  0.00000 52.36509 28.25112  0.00000 52.02819 44.78551  0.00000  0.00000  0.00000 36.93738 35.82976 27.81964 35.85570...
%  37.62919 39.02393  0.00000 33.27401  0.00000  0.00000 31.86896  0.00000 67.15605 40.87138 35.18910 26.79943 50.02942...
%  0.00000 40.76398 40.34860  0.00000  0.00000 32.33743 47.82174  0.00000  0.00000 33.00269  0.00000  0.00000  0.00000...
%  0.00000  0.00000  0.00000 32.93664 37.60613 50.65821 38.57285 48.92646  0.00000 24.38398  0.00000 44.21942  0.00000...
%  38.75010 49.77934 28.84896  0.00000 23.88604 30.71707 44.08390 33.83719  0.00000 43.21912 28.48215 58.84356 41.91214...
%  45.58200 28.85448 48.12014 29.67271 42.56349 47.57380 34.24586  0.00000  0.00000 31.71934 31.00128 34.63851 50.73755...
%  42.46001 39.67991  0.00000 44.20038  0.00000 46.24531 43.89923 40.38992 42.85475 32.93108  0.00000 45.60865 25.78272...
% 46.71609  0.00000 35.43191 35.32543 44.55382  0.00000 42.39178 48.66355 44.69534 53.19848 40.04896  0.00000  0.00000...
% 0.00000  0.00000  0.00000 45.41978  0.00000 49.81858 36.02994 43.68003 44.63009 43.11467 44.59988  0.00000 51.43115...
% 26.79036 33.99547  0.00000  0.00000  0.00000  0.00000 35.34532  0.00000 37.77922 44.35775 48.47652 32.74607 44.36597...
% 39.10526 40.38229  0.00000  0.00000  0.00000  0.00000  0.00000 44.35459 38.38181  0.00000 63.22066 35.71474  0.00000...
% 0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 38.80365  0.00000  0.00000  0.00000  0.00000...
% 0.00000  0.00000 46.15026  0.00000  0.00000  0.00000  0.00000 50.18461 34.88843  0.00000  0.00000  0.00000  0.00000...
% 0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 57.51813 38.25836  0.00000...
% 0.00000  0.00000  0.00000  0.00000 42.49013  0.00000  0.00000  0.00000  0.00000 52.13451 31.51952 51.87294 30.43879...
% 49.40369 45.29968  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 31.33613 35.20683 40.56148...
% 0.00000  0.00000 33.53586 32.38867 54.56636 31.87058 36.31865 25.28996  0.00000  0.00000 28.35744 33.69295  0.00000 ...
% 0.00000  0.00000  0.00000  0.00000  0.00000 40.14323 52.72375  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 ...
% 0.00000  0.00000  0.00000  0.00000];

% ri = [43.66880 37.10516 49.73733 48.65542 24.98297  0.00000 42.01133 41.39789 36.45131 53.13648 39.05956 26.32464 35.69962 ...
%  42.54571 52.15527 42.86418  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 44.35310 41.27926 38.95544 41.18096 ...
%  43.07984 27.52111 27.78609 56.58244 37.33849 62.66937 53.88181 49.32943 41.91341 42.21693  0.00000 42.02724 58.18023 ...
%  55.55239  0.00000 36.08892 33.93424 52.94468 29.20890 30.81799  0.00000  0.00000 54.89182 35.20294 37.74394 47.08511 ...
%  49.10868 46.67417 33.28893 38.47802 42.21792 42.48464 29.30682 35.58005 41.27164 38.69224 52.57662  0.00000  0.00000 ...
%  46.14109 44.79867 23.24060 66.65016 40.19555 28.59641 45.22966 31.69525  0.00000  0.00000  0.00000  0.00000  0.00000  ...
%  0.00000 35.88842 30.18600  0.00000  0.00000 30.89917  0.00000  0.00000 43.64291 30.72794 67.79300 44.31165 45.49622 ...
%  0.00000 59.56688 27.79334 64.51830 41.24021 35.80024 28.42216 33.53608 38.93670 29.99428  0.00000 32.98181 47.11689 ...
% 34.15286  0.00000  0.00000 47.81846  0.00000  0.00000  0.00000 35.62809 34.29100 51.76234 32.88560 30.70856  0.00000 ...
% 0.00000  0.00000 37.97775  0.00000 36.44733 45.10436 31.45859 47.82601  0.00000  0.00000  0.00000  0.00000 42.80673 ...
% 53.21322  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 48.80395 39.61845  0.00000 28.97520 37.81840 ...
% 0.00000 39.80627 42.88475 29.87187 39.24468 27.12355 34.20888  0.00000 36.72078 44.89240  0.00000  0.00000  0.00000 ...
% 0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 50.90525 42.55038  0.00000  0.00000  0.00000 ...
% 0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 25.47199 43.78521 53.28233 53.80084  0.00000  0.00000  0.00000 ...
% 0.00000  0.00000 31.07413 31.14914  0.00000  0.00000  0.00000  0.00000 35.27256 29.61364  0.00000  0.00000  0.00000 ...
% 31.93022 40.25394 45.41414 32.62050  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 29.87838  0.00000  0.00000 ...
% 0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 47.52377 39.48972  0.00000  0.00000  0.00000  0.00000  0.00000 ...
% 0.00000  0.00000  0.00000 29.12350 36.00970  0.00000 35.53189 41.51676 40.80027 36.21249 37.57873  0.00000  0.00000 ...
% 0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 34.01809  0.00000  0.00000  0.00000 29.97154 ...
% 32.15581  0.00000  0.00000  0.00000];

% ri = [0.00000 41.35486 32.11886 51.71969 35.24363 37.42980  0.00000 37.46397 42.37605 48.00097 26.14385  0.00000  0.00000 ...
% 0.00000  0.00000  0.00000  0.00000 41.80490  0.00000  0.00000 43.73346 49.08695 41.31972 53.43370 52.12063 47.65419 ...
% 40.99912 34.62077 42.14501 34.39579 56.50137 51.96822 52.73084 51.05416  0.00000  0.00000  0.00000 41.20479 41.43981 ...
% 37.25062 28.34972 47.59246 23.64491 31.30500 48.93794 52.39682 28.98320 45.68923 41.11324  0.00000  0.00000  0.00000 ...
% 36.31678 33.47594 44.93294 24.50591 20.65066 41.94103 34.29249 39.34528 34.09254  0.00000  0.00000  0.00000  0.00000 ...
% 0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 28.51220 45.60155 38.58453  0.00000 ...
% 0.00000  0.00000  0.00000 54.35243 49.35659  0.00000  0.00000  0.00000  0.00000  0.00000 35.43831 42.19189 35.55730 ...
% 24.55727 45.76578 45.88097 51.19356 56.00228 40.92504 35.10624 31.42291 52.55274 28.55306 50.49909 32.68903 41.31777 ...
% 36.59625 45.60468 34.11082 25.35204  0.00000  0.00000  0.00000  0.00000 41.39048 19.68510 24.18539 34.64231 57.30853 ...
% 27.24918 32.12342 42.53728 39.42668 44.22874  0.00000  0.00000 41.29412 40.42701 33.18594 63.70723 38.56885 45.42945 ...
% 43.85062 27.22852  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 30.67332 25.27144 39.55790  0.00000 ...
% 51.36796  0.00000  0.00000 32.34587 44.43645 52.17003  0.00000  0.00000  0.00000  0.00000 37.12355 43.86606 46.33714 ...
% 47.31816 37.93914 34.31902  0.00000 37.99531  0.00000  0.00000  0.00000 39.38272 46.33220 35.26484 46.76839 50.43444 ...
% 0.00000  0.00000  0.00000  0.00000 30.20349 46.09277 40.21174  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 ...
% 0.00000  0.00000 36.86250 32.15909  0.00000  0.00000 50.17329 57.09586  0.00000  0.00000  0.00000 30.15058  0.00000 ...
% 0.00000  0.00000  0.00000  0.00000  0.00000 46.19656  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 ...
% 51.49187 43.49469 32.89251  0.00000  0.00000 26.73933 30.57581  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 ...
% 29.29956 31.14484 41.97272 34.29173  0.00000  0.00000  0.00000  0.00000  0.00000 30.80452  0.00000  0.00000  0.00000 ...
% 0.00000  0.00000  0.00000  0.00000 40.01746 48.05671  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000 ...
% 0.00000 30.98257  0.00000  0.00000];

tw = 250;
Tend = 250;
delta_t = 1;
ks = 0.06;
kr = 0.004;
kp = 0.014;
kw = 0.4;
kf = 0.5;
kd = 0;
kk = 0;
ks_start = ks/2;

param.S0 = S0;
param.M0 = M0;
param.W0 = W0;
param.X0 = [param.M0 ; param.S0; param.W0];
param.horizon = tw;
param.ks = ks;
param.kr = kr;
param.kp = kp;
param.kk = kk;
param.kw = kw;
param.kf = kf;
param.ri = ri;
param.kd = kd;
param.deltat = delta_t;
param.kp=kp;

%Time sequence
time_sequence = param.deltat:param.deltat:param.horizon;
input_length = size(time_sequence, 2);

%Define optimisation inputs
X0 = zeros(4,input_length);
X0(1,:) = ones(1,input_length)*ks_start;
X0(2,:) = ones(1,input_length)*param.M0;
X0(3,:) = ones(1,input_length)*param.S0;
X0(4,:) = ones(1,input_length)*param.W0;
lb = zeros(4,input_length);
ub = ones(4,input_length);
ub(1,:) = ub(1,:)*param.ks;
ub(2:4,:) = ub(2:4,:)*inf;
A = [];
b = [];
Aeq = [];
beq = [];

goals = [0, 0.45 0.5, 0.55, 0.6, 0.65, 0.75 , 1];
goals = 0.75;

for i = 1:5
    for goal = goals 
        filename = strcat("opt_detail_" + i + "_rain_1_goal_" + goal + ".csv"); 
        opts = optimoptions('fmincon','MaxFunctionEvaluations',10000000,'MaxIterations',10000000);
        
        param.kf = goal;
        
        ub(1,:) = random("Uniform", 0, param.ks, 1, input_length);
        
        %Perform optimisation
        obj = @(x) objective_discounting(x, param);
        nlc = @(x) nonlcon_water_in(x, param);
        [x,fval,exitflag,output] = fmincon(obj,X0,A,b,Aeq,beq,lb,ub,nlc, opts);
        
        csvwrite(filename,x')
    end
end
